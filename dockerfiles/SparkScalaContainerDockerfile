# This ARG isn't used but prevents warnings in the build script
ARG CODE_VERSION
FROM maven:latest

RUN apt-get update \
  && apt-get install -y libzmq5 libzmq3-dev git pkg-config libtool autoconf g++ make \
  && git clone https://github.com/zeromq/jzmq.git /root/jzmq \
  && cd /root/jzmq/jzmq-jni \
  && ./autogen.sh \
  && ./configure \
  && make \
  && make install

ADD ./containers/jvm/pom.xml /root/container/

WORKDIR /root/container

RUN ["mvn","verify","clean","--fail-never"]

RUN ["mvn","dependency:go-offline","--fail-never"]

COPY ./containers/jvm/ /root/container

WORKDIR /root/container

RUN mkdir -p /model \
      && cd /root/container \
      && mvn clean package -DskipTests

ENV CLIPPER_MODEL_PATH=/model

CMD ["java", "-Djava.library.path=/usr/local/lib", "-Xmx512m", "-cp", "/root/container/spark-container-impl/target/spark-container-impl-0.1.jar", "ai.clipper.spark.container.impl.ContainerMain"]

# vim: set filetype=dockerfile:
